---
sidebar_position: 5
sidebar_label: Mega Alerts
custom_edit_url: null
---
# Методология расчета MegaAlerts

## Описание датасета

**MegaAlerts** — датасет торговых аномалий по акциям, фьючерсам и валюте на Московской бирже, отслеживаемых в режиме реального времени (online). Система автоматически фиксирует экстремальные значения торговых показателей, которые выходят за установленные пороговые уровни.

### Основные характеристики

- **Режим работы:** Real-time мониторинг в течение торгового дня
- **Охват:** Все ликвидные акции на Московской бирже
- **Гранулярность данных:** Минутные свечи
- **Исторический период для расчета порогов:** 3 месяца (90 дней)
- **Статистический метод:** 99,9 перцентиль исторических значений для большинства показателей, абсолютные экстремумы (min/max) для исторических рекордов

## Типы отслеживаемых аномалий

### Аномалии по объемам торгов

| Код алерта | Название | Описание |
|------------|----------|----------|
| `vol_s_99_9_pctl` | **Крупная продажа** | Объем продаж превысил 99,9 перцентиль |
| `vol_b_99_9_pctl` | **Крупная покупка** | Объем покупок превысил 99,9 перцентиль |
| `vol_99_9_pctl` | **Большой объем торгов** | Суммарный объем превысил 99,9 перцентиль |
| `vol_s_max` | **Макс продажа** | Объем продаж достиг исторического максимума за 90 дней |
| `vol_b_max` | **Макс покупка** | Объем покупок достиг исторического максимума за 90 дней |
| `vol_max` | **Макс объем** | Суммарный объем достиг исторического максимума за 90 дней |

### Аномалии по чистому объему (net volume)

| Код алерта | Название | Описание |
|------------|----------|----------|
| `net_vol_99_9_pctl-` | **Крупная продажа (net)** | Чистый объем (покупки - продажи) в отрицательную сторону превысил 99,9 перцентиль |
| `net_vol_99_9_pctl+` | **Крупная покупка (net)** | Чистый объем (покупки - продажи) в положительную сторону превысил 99,9 перцентиль |
| `net_vol_min` | **Макс продажа (net)** | Чистый объем достиг исторического минимума (максимум продаж) за 90 дней |
| `net_vol_max` | **Макс покупка (net)** | Чистый объем достиг исторического максимума (максимум покупок) за 90 дней |

### Аномалии по изменению цены

| Код алерта | Название | Описание |
|------------|----------|----------|
| `pr_change_99_9_pctl-` | **Сильное падение цены** | Падение цены превысило 99,9 перцентиль |
| `pr_change_99_9_pctl+` | **Сильный рост цены** | Рост цены превысил 99,9 перцентиль |
| `pr_change_min` | **Макс падение цены** | Падение цены достигло исторического максимума за 90 дней |
| `pr_change_max` | **Макс рост цены** | Рост цены достиг исторического максимума за 90 дней |

### Аномалии по уровням цен

| Код алерта | Название | Описание |
|------------|----------|----------|
| `pr_high_max` | **Макс цена** | Цена достигла исторического максимума за 90 дней |
| `pr_low_min` | **Мин цена** | Цена достигла исторического минимума за 90 дней |

## Методология расчета

### Этап 1: Расчет пороговых значений (Threshold)

Для каждой акции и каждого типа показателя используются два типа порогов:

#### Пороги на основе 99,9 перцентиля

Применяются для алертов с окончанием `_99_9_pctl`:

1. **Сбор исторических данных:** Анализируются минутные свечи за последние **90 дней**
2. **Расчет перцентиля:** Для каждого показателя определяется **99,9 перцентиль** распределения
3. **Установка порога:** Значение 99,9 перцентиля становится пороговым значением (Threshold)

**Пример:** Если за последние 90 дней по акции SBER объем торгов в минуту составлял от 100 до 50000 лотов, и 99,9 перцентиль = 45000 лотов, то Threshold устанавливается на уровне 45000 лотов.

#### Пороги на основе исторических экстремумов

Применяются для алертов с окончанием `_min` или `_max`:

1. **Сбор исторических данных:** Анализируются минутные свечи за последние **90 дней**
2. **Определение экстремума:** Находится абсолютный минимум или максимум показателя
3. **Установка порога:** Минимальное или максимальное значение становится порогом

**Пример:** Если за последние 90 дней максимальная цена акции SBER составляла 280 руб, то при достижении или превышении этого уровня формируется алерт `pr_high_max`.

### Этап 2: Мониторинг в реальном времени

В течение торгового дня система:

1. **Получает данные:** Каждую минуту фиксируются текущие значения всех отслеживаемых показателей
2. **Сравнивает с порогом:** 
   - Для алертов `_99_9_pctl`: если значение **превышает** Threshold, формируется сигнал
   - Для алертов `_max`: если значение **достигает или превышает** исторический максимум, формируется сигнал
   - Для алертов `_min`: если значение **достигает или опускается ниже** исторического минимума, формируется сигнал
3. **Записывает аномалию:** Сигнал сохраняется с указанием времени, тикера, типа аномалии, текущего значения и порогового значения

### Этап 3: Расчет статистики после аномалии

Для каждой зафиксированной аномалии система рассчитывает:

**Reference, 15 min stat** — статистика изменения цены через 15 минут после возникновения аномалии (на основе исторических данных за последние 90 дней)

Формат статистики: **изменение цены ↑количество наблюдений ↓количество наблюдений**

Где:
- **Изменение цены** — среднее изменение цены в процентах через 15 минут
- **↑ количество** — сколько раз цена росла после такой аномалии
- **↓ количество** — сколько раз цена падала после такой аномалии

## Структура датасета

Каждая запись содержит следующие поля:

| Поле | Описание |
|------|----------|
| **Time** | Время возникновения аномалии (чч:мм:сс) |
| **Ticker** | Тикер акции |
| **Alert** | Тип аномалии |
| **Value** | Аномальное значение показателя |
| **Threshold** | Пороговое значение (99,9 перцентиль или исторический экстремум) |
| **Reference** | Статистика изменения цены через 5, 15, 30 и 60 минут |

## Пример данных

| Time | Ticker | Alert | Value | Threshold | Reference |
|------|--------|-------|-------|-----------|------------------------|
| 12:07:00 | KUBE | Крупная продажа | 350 лот | 230 лот | +0.88% ↑6 ↓1 |
| 12:07:00 | KUBE | Большой объем торгов | 350 лот | 290 лот | +1.67% ↑8 ↓1 |
| 12:07:00 | KUBE | Крупная продажа (net) | -350 лот | -270 лот | +1.33% ↑5 ↓0 |
| 12:06:00 | TCSG | Крупная покупка | 41030 лот | 37611 лот | -0.04% ↑63 ↓76 |
| 12:06:00 | KUBE | Макс цена | 285.50 руб | 285.00 руб | +0.52% ↑12 ↓8 |

### Интерпретация примера

**Строка 1:** В 12:07:00 по акции KUBE зафиксирована крупная продажа объемом 350 лотов, что превышает пороговое значение 230 лотов (99,9 перцентиль). По историческим данным, после таких аномалий цена в среднем росла на +0.88% в течение 15 минут (в 6 случаях росла, в 1 случае падала).

**Строка 5:** В 12:06:00 по акции KUBE зафиксирован исторический максимум цены 285.50 руб, что превышает предыдущий максимум за 90 дней (285.00 руб). По историческим данным, после достижения максимумов цена в среднем росла на +0.52% в течение 15 минут (в 12 случаях росла, в 8 случаях падала).

:::note
    Статистика Reference показывает, что происходило с ценой **в прошлом** после подобных аномалий. Это **не прогноз**, а исторические данные для справки.
:::

## Применение данных

Датасет MegaAlerts позволяет:

- Отслеживать необычную торговую активность в режиме реального времени
- Быстро реагировать на экстремальные движения цены или объемов
- Анализировать исторические паттерны поведения цены после аномалий
- Фильтровать сигналы по типу аномалии, тикеру или частоте возникновения
- Оценивать концентрацию аномалий в определенных бумагах
- Выявлять пробои исторических максимумов и минимумов

## Обновление пороговых значений

Пороговые значения (Threshold) пересчитываются:

- **Ежедневно** перед началом торгов на основе скользящего окна последних 90 дней
- Это позволяет адаптироваться к изменению волатильности и ликвидности инструментов